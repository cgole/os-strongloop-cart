module.exports = exports = merge;

var NESTED_FIELDS = [
  '_attachments',
  'users',
  'time',
  'dist-tags',
  'versions'
];

/**
 * Merges package metadata from multiple sources into a single document.
 * @param {Array.<Object>} sources sorted by priority
 */
function merge(sources) {
  var result = {};

  sources.forEach(function(src) {
    mergeSource(src, result);
  });

  return result;
}

function mergeSource(src, result) {
  Object.keys(src).forEach(function(prop) {
    mergeProperty(prop, src, result);
  });
}

function mergeProperty(prop, src, dest) {
  if (NESTED_FIELDS.indexOf(prop) !== -1) {
    if (dest[prop] === undefined) {
      dest[prop] = {};
    }
    mergeNestedProperty(src[prop], dest[prop]);
  } else {
    if (dest[prop] === undefined) {
      dest[prop] = src[prop];
    }
  }
}

function mergeNestedProperty(src, dest) {
  Object.keys(src).forEach(function(prop) {
    if (dest[prop] !== undefined) return;
    dest[prop] = src[prop];
  });
}
